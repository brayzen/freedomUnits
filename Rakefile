# Add your own tasks in files placed in lib/tasks ending in .rake,
# for example lib/tasks/capistrano.rake, and they will automatically be available to Rake.

require File.expand_path('../config/application', __FILE__)

Rails.application.load_tasks

require 'date'
require 'timeout'
class Commodity
  attr_accessor :name, :sma50, :invest_point, :sell_point, :data, :close, :sma_cleared

  def initialize(name)
    @name = name
    @invest_point = 0
    @sell_point = 0
    @data = get_data
    sleep 3
    # data_ready?
    # @close = close
    # @sma50 = 0
    # @sma_cleared = true
    close
    find_SMA(@data)
    sma_cleared
  end

  def data_ready?
    if !@data
      Rails.logger.info 'NO DATA YET'
      sleep 3
      data_ready?
    end
    @data
  end

  def find_SMA(data, start_date=0, end_date=50)
    collection = data["dataset_data"]["data"].slice(start_date.to_i, end_date.to_i).map{ |day| day[4] }
    @sma50 = collection.reduce{ |memo, cur| memo + cur } / collection.length
  end

  def sma_cleared(avg=50, days=50)
    start_date, end_date = 1, 1 + days
    array_of_smas = []
    avg.times do
      sma = find_SMA(data, start_date, end_date)
      return false if sma < @close
      start_date += 1
      end_date += 1
    end
    return true
  end

  def get_data
    # puts "THIS SHOULD BE THE NAME : #{@name}"
    data = HTTParty.get("https://www.quandl.com/api/v3/datasets/WIKI/#{@name}/data.json?api_key=9hVJCtTSTR2Aj6rtBZ8L&end_date=2015-10-27&start_date=2015-6-20")

    # curl "https://www.quandl.com/api/v3/datasets/WIKI/" + @name + "/data.json?end_date=2015-10-27&start_date=2015-6-20"
    #AAPL
    # {"dataset_data"=>{"limit"=>nil, "transform"=>nil, "column_index"=>nil, "column_names"=>["Date", "Open", "High", "Low", "Close", "Volume", "Ex-Dividend", "Split Ratio", "Adj. Open", "Adj. High", "Adj. Low", "Adj. Close", "Adj. Volume"], "start_date"=>"2015-09-03", "end_date"=>"2015-12-11", "frequency"=>"daily", "data"=>[["2015-12-11", 115.19, 115.39, 112.851, 113.18, 46396531.0, 0.0, 1.0, 115.19, 115.39, 112.851, 113.18, 46396531.0], ["2015-12-10", 116.04, 116.94, 115.51, 116.17, 28858993.0, 0.0, 1.0, 116.04, 116.94, 115.51, 116.17, 28858993.0], ["2015-12-09", 117.64, 117.69, 115.08, 115.62, 44745213.0, 0.0, 1.0, 117.64, 117.69, 115.08, 115.62, 44745213.0], ["2015-12-08", 117.52, 118.6, 116.86, 118.23, 34086875.0, 0.0, 1.0, 117.52, 118.6, 116.86, 118.23, 34086875.0], ["2015-12-07", 118.98, 119.86, 117.81, 118.28, 31801965.0, 0.0, 1.0, 118.98, 119.86, 117.81, 118.28, 31801965.0], ["2015-12-04", 115.29, 119.25, 115.11, 119.03, 56351301.0, 0.0, 1.0, 115.29, 119.25, 115.11, 119.03, 56351301.0], ["2015-12-03", 116.55, 116.79, 114.22, 115.17, 40935107.0, 0.0, 1.0, 116.55, 116.79, 114.22, 115.17, 40935107.0], ["2015-12-02", 117.05, 118.11, 116.08, 116.28, 32793916.0, 0.0, 1.0, 117.05, 118.11, 116.08, 116.28, 32793916.0], ["2015-12-01", 118.75, 118.81, 116.86, 117.34, 34501246.0, 0.0, 1.0, 118.75, 118.81, 116.86, 117.34, 34501246.0], ["2015-11-30", 117.99, 119.41, 117.75, 118.35, 37074611.0, 0.0, 1.0, 117.99, 119.41, 117.75, 118.35, 37074611.0], ["2015-11-27", 118.29, 118.41, 117.6, 117.81, 13038955.0, 0.0, 1.0, 118.29, 118.41, 117.6, 117.81, 13038955.0], ["2015-11-25", 119.21, 119.23, 117.92, 118.03, 21258090.0, 0.0, 1.0, 119.21, 119.23, 117.92, 118.03, 21258090.0], ["2015-11-24", 117.33, 119.35, 117.12, 118.88, 42342435.0, 0.0, 1.0, 117.33, 119.35, 117.12, 118.88, 42342435.0], ["2015-11-23", 119.27, 119.73, 117.34, 117.76, 31788032.0, 0.0, 1.0, 119.27, 119.73, 117.34, 117.76, 31788032.0], ["2015-11-20", 119.2, 119.92, 118.85, 119.3, 33780538.0, 0.0, 1.0, 119.2, 119.92, 118.85, 119.3, 33780538.0], ["2015-11-19", 117.64, 119.75, 116.76, 118.78, 42828053.0, 0.0, 1.0, 117.64, 119.75, 116.76, 118.78, 42828053.0], ["2015-11-18", 115.76, 117.49, 115.5, 117.29, 45727223.0, 0.0, 1.0, 115.76, 117.49, 115.5, 117.29, 45727223.0], ["2015-11-17", 114.92, 115.05, 113.32, 113.69, 27196079.0, 0.0, 1.0, 114.92, 115.05, 113.32, 113.69, 27196079.0], ["2015-11-16", 111.38, 114.24, 111.0, 114.175, 37370349.0, 0.0, 1.0, 111.38, 114.24, 111.0, 114.175, 37370349.0], ["2015-11-13", 115.2, 115.57, 112.27, 112.34, 44931935.0, 0.0, 1.0, 115.2, 115.57, 112.27, 112.34, 44931935.0], ["2015-11-12", 116.26, 116.82, 115.65, 115.72, 31820442.0, 0.0, 1.0, 116.26, 116.82, 115.65, 115.72, 31820442.0], ["2015-11-11", 116.37, 117.42, 115.21, 116.12, 44866694.0, 0.0, 1.0, 116.37, 117.42, 115.21, 116.12, 44866694.0], ["2015-11-10", 116.9, 118.07, 116.061, 116.73, 58457469.0, 0.0, 1.0, 116.9, 118.07, 116.061, 116.73, 58457469.0], ["2015-11-09", 120.96, 121.81, 120.05, 120.57, 33379072.0, 0.0, 1.0, 120.96, 121.81, 120.05, 120.57, 33379072.0], ["2015-11-06", 121.11, 121.81, 120.62, 121.06, 32697456.0, 0.0, 1.0, 121.11, 121.81, 120.62, 121.06, 32697456.0], ["2015-11-05", 121.85, 122.69, 120.18, 120.92, 38418373.0, 0.52, 1.0, 121.85, 122.69, 120.18, 120.92, 38418373.0], ["2015-11-04", 123.13, 123.82, 121.62, 122.0, 44156213.0, 0.0, 1.0, 122.60276350461, 123.28980895916, 121.09922924901, 121.47760210804, 44156213.0], ["2015-11-03", 120.79, 123.49, 120.7, 122.57, 44813352.0, 0.0, 1.0, 120.27278326746, 122.96122200264, 120.18316864295, 122.04516139657, 44813352.0], ["2015-11-02", 119.87, 121.36, 119.61, 121.18, 31688638.0, 0.0, 1.0, 119.3567226614, 120.84034255599, 119.09783596838, 120.66111330698, 31688638.0], ["2015-10-30", 120.99, 121.22, 119.45, 119.5, 48364078.0, 0.0, 1.0, 120.47192687747, 120.70094202899, 118.93852108037, 118.98830698287, 48364078.0], ["2015-10-29", 118.7, 120.69, 118.27, 120.53, 50049564.0, 0.0, 1.0, 118.19173254282, 120.17321146245, 117.76357378129, 120.01389657444, 50049564.0], ["2015-10-28", 116.93, 119.3, 116.06, 119.28, 84697735.0, 0.0, 1.0, 116.4293115942, 118.78916337286, 115.56303689065, 118.76924901186, 84697735.0], ["2015-10-27", 115.4, 116.54, 113.99, 114.55, 56542594.0, 0.0, 1.0, 114.9058629776, 116.04098155468, 113.50190052701, 114.05950263505, 56542594.0], ["2015-10-26", 118.08, 118.13, 114.92, 115.21, 65874051.0, 0.0, 1.0, 117.57438735178, 117.62417325428, 114.42791831357, 114.71667654809, 65874051.0], ["2015-10-23", 116.7, 119.228, 116.33, 119.08, 58451404.0, 0.0, 1.0, 116.20029644269, 118.71747167325, 115.83188076416, 118.57010540184, 58451404.0], ["2015-10-22", 114.33, 115.5, 114.1, 115.47, 40816364.0, 0.0, 1.0, 113.84044466403, 115.00543478261, 113.61142951252, 114.97556324111, 40816364.0], ["2015-10-21", 114.0, 115.58, 113.7, 113.76, 41708795.0, 0.0, 1.0, 113.51185770751, 115.08509222661, 113.21314229249, 113.27288537549, 41708795.0], ["2015-10-20", 111.34, 114.17, 110.82, 113.78, 48539823.0, 0.0, 1.0, 110.86324769433, 113.68112977602, 110.3454743083, 113.2927997365, 48539823.0], ["2015-10-19", 110.8, 111.75, 110.11, 111.73, 29515641.0, 0.0, 1.0, 110.3255599473, 111.27149209486, 109.63851449275, 111.25157773386, 29515641.0], ["2015-10-16", 111.78, 112.0, 110.53, 111.04, 38001868.0, 0.0, 1.0, 111.30136363636, 111.52042160738, 110.05671607378, 110.56453227931, 38001868.0], ["2015-10-15", 110.93, 112.1, 110.49, 111.8, 37270444.0, 0.0, 1.0, 110.45500329381, 111.61999341238, 110.01688735178, 111.32127799736, 37270444.0], ["2015-10-14", 111.29, 111.52, 109.56, 110.21, 44134440.0, 0.0, 1.0, 110.81346179183, 111.04247694335, 109.09086956522, 109.73808629776, 44134440.0], ["2015-10-13", 110.82, 112.45, 110.68, 111.79, 32014688.0, 0.0, 1.0, 110.3454743083, 111.96849472991, 110.20607378129, 111.31132081686, 32014688.0], ["2015-10-12", 112.73, 112.75, 111.44, 111.6, 30467204.0, 0.0, 1.0, 112.24729578393, 112.26721014493, 110.96281949934, 111.12213438735, 30467204.0], ["2015-10-09", 110.0, 112.28, 109.49, 112.09, 51599856.0, 0.0, 1.0, 109.52898550725, 111.7992226614, 109.02116930171, 111.61003623188, 51599856.0], ["2015-10-08", 110.19, 110.19, 108.21, 109.5, 61491821.0, 0.0, 1.0, 109.71817193676, 109.71817193676, 107.74665019763, 109.03112648221, 61491821.0], ["2015-10-07", 111.74, 111.77, 109.41, 110.67, 46475255.0, 0.0, 1.0, 111.26153491436, 111.29140645586, 108.94151185771, 110.19611660079, 46475255.0], ["2015-10-06", 110.63, 111.74, 109.765, 111.31, 48342635.0, 0.0, 1.0, 110.15628787879, 111.26153491436, 109.29499176548, 110.83337615283, 48342635.0], ["2015-10-05", 109.88, 111.3698, 109.07, 110.78, 51445837.0, 0.0, 1.0, 109.40949934124, 110.89292009223, 108.60296772069, 110.3056455863, 51445837.0], ["2015-10-02", 108.01, 111.0136, 107.55, 110.38, 57383318.0, 0.0, 1.0, 107.54750658762, 110.53824532279, 107.08947628458, 109.90735836627, 57383318.0], ["2015-10-01", 109.07, 109.62, 107.31, 109.57, 63445783.0, 0.0, 1.0, 108.60296772069, 109.15061264822, 106.85050395257, 109.10082674572, 63445783.0], ["2015-09-30", 110.17, 111.54, 108.73, 109.95, 65041596.0, 0.0, 1.0, 109.69825757576, 111.06239130435, 108.26442358366, 109.47919960474, 65041596.0], ["2015-09-29", 112.83, 113.51, 107.86, 109.06, 72667046.0, 0.0, 1.0, 112.34686758893, 113.02395586298, 107.39814888011, 108.59301054018, 72667046.0], ["2015-09-28", 113.85, 114.57, 112.44, 112.44, 50782189.0, 0.0, 1.0, 113.3625, 114.07941699605, 111.95853754941, 111.95853754941, 50782189.0], ["2015-09-25", 116.44, 116.69, 114.02, 114.72, 55628400.0, 0.0, 1.0, 115.94140974967, 116.19033926219, 113.53177206851, 114.22877470356, 55628400.0], ["2015-09-24", 113.25, 115.5, 112.37, 115.0, 49487464.0, 0.0, 1.0, 112.76506916996, 115.00543478261, 111.8888372859, 114.50757575758, 49487464.0], ["2015-09-23", 113.63, 114.72, 113.3, 114.32, 35448102.0, 0.0, 1.0, 113.14344202899, 114.22877470356, 112.81485507246, 113.83048748353, 35448102.0], ["2015-09-22", 113.38, 114.18, 112.5201, 113.432, 49639709.0, 0.0, 1.0, 112.89451251647, 113.69108695652, 112.03829456522, 112.94628985507, 49639709.0], ["2015-09-21", 113.67, 115.37, 113.66, 115.21, 45941907.0, 0.0, 1.0, 113.18327075099, 114.8759914361, 113.17331357049, 114.71667654809, 45941907.0], ["2015-09-18", 112.21, 114.3, 111.87, 113.45, 70688038.0, 0.0, 1.0, 111.72952239789, 113.81057312253, 111.39097826087, 112.96421277997, 70688038.0], ["2015-09-17", 115.66, 116.49, 113.715, 113.92, 63099857.0, 0.0, 1.0, 115.16474967062, 115.99119565217, 113.22807806324, 113.4322002635, 63099857.0], ["2015-09-16", 116.25, 116.54, 115.44, 116.35, 36733558.0, 0.0, 1.0, 115.75222332016, 116.04098155468, 114.9456916996, 115.85179512516, 36733558.0], ["2015-09-15", 115.93, 116.53, 114.42, 116.28, 42765371.0, 0.0, 1.0, 115.43359354414, 116.03102437418, 113.93005928854, 115.78209486166, 42765371.0], ["2015-09-14", 116.58, 116.89, 114.86, 115.3, 57718121.0, 0.0, 1.0, 116.08081027668, 116.3894828722, 114.36817523057, 114.8062911726, 57718121.0], ["2015-09-11", 111.79, 114.21, 111.76, 114.21, 49915473.0, 0.0, 1.0, 111.31132081686, 113.72095849802, 111.28144927536, 113.72095849802, 49915473.0], ["2015-09-10", 110.27, 113.2825, 109.9, 112.57, 62892831.0, 0.0, 1.0, 109.79782938076, 112.79743000659, 109.42941370224, 112.08798089592, 62892831.0], ["2015-09-09", 113.76, 114.02, 109.77, 110.15, 85010804.0, 0.0, 1.0, 113.27288537549, 113.53177206851, 109.29997035573, 109.67834321476, 85010804.0], ["2015-09-08", 111.65, 112.56, 110.32, 112.21, 53458236.0, 0.0, 1.0, 111.17192028986, 112.07802371542, 109.84761528327, 111.72952239789, 53458236.0], ["2015-09-04", 108.97, 110.45, 108.51, 109.27, 49478188.0, 0.0, 1.0, 108.50339591568, 109.97705862978, 108.04536561265, 108.8021113307, 49478188.0], ["2015-09-03", 112.49, 112.78, 110.04, 110.37, 52760161.0, 0.0, 1.0, 112.00832345191, 112.29708168643, 109.56881422925, 109.89740118577, 52760161.0]], "collapse"=>nil, "order"=>"desc"}}
    #WMT
    # {"dataset_data"=>{"limit"=>nil, "transform"=>nil, "column_index"=>nil, "column_names"=>["Date", "Open", "High", "Low", "Close", "Volume", "Ex-Dividend", "Split Ratio", "Adj. Open", "Adj. High", "Adj. Low", "Adj. Close", "Adj. Volume"], "start_date"=>"2015-09-03", "end_date"=>"2015-12-11", "frequency"=>"daily", "data"=>[["2015-12-11", 59.05, 59.53, 58.81, 59.36, 9709111.0, 0.0, 1.0, 59.05, 59.53, 58.81, 59.36, 9709111.0], ["2015-12-10", 59.13, 60.09, 59.09, 59.56, 11357214.0, 0.0, 1.0, 59.13, 60.09, 59.09, 59.56, 11357214.0], ["2015-12-09", 59.26, 60.11, 58.9, 59.13, 8981715.0, 0.0, 1.0, 59.26, 60.11, 58.9, 59.13, 8981715.0], ["2015-12-08", 60.07, 60.49, 59.5, 59.61, 10363510.0, 0.0, 1.0, 60.07, 60.49, 59.5, 59.61, 10363510.0], ["2015-12-07", 59.57, 60.73, 59.57, 60.5, 11585293.0, 0.0, 1.0, 59.57, 60.73, 59.57, 60.5, 11585293.0], ["2015-12-04", 59.05, 59.85, 59.03, 59.66, 10433505.0, 0.0, 1.0, 59.05, 59.85, 59.03, 59.66, 10433505.0], ["2015-12-03", 58.69, 59.66, 58.595, 59.04, 15743219.0, 0.0, 1.0, 58.69, 59.66, 58.595, 59.04, 15743219.0], ["2015-12-02", 58.61, 59.29, 58.315, 58.35, 13523638.0, 0.49, 1.0, 58.61, 59.29, 58.315, 58.35, 13523638.0], ["2015-12-01", 59.13, 59.29, 58.65, 58.99, 12191992.0, 0.0, 1.0, 58.637584976207, 58.796252549286, 58.161582256968, 58.498750849762, 12191992.0], ["2015-11-30", 59.87, 60.06, 58.73, 58.84, 13683103.0, 0.0, 1.0, 59.3714225017, 59.559840244731, 58.240916043508, 58.35, 13683103.0], ["2015-11-27", 60.44, 60.69, 59.87, 59.89, 5340015.0, 0.0, 1.0, 59.936675730795, 60.184593813732, 59.3714225017, 59.391255948334, 5340015.0], ["2015-11-25", 60.0, 60.71, 59.875, 60.24, 7820151.0, 0.0, 1.0, 59.500339904827, 60.204427260367, 59.376380863358, 59.738341264446, 7820151.0], ["2015-11-24", 59.95, 60.415, 59.86, 59.92, 12417331.0, 0.0, 1.0, 59.450756288239, 59.911883922502, 59.361505778382, 59.421006118287, 12417331.0], ["2015-11-23", 60.29, 60.735, 59.88, 60.26, 10568402.0, 0.0, 1.0, 59.787924881033, 60.229219068661, 59.381339225017, 59.758174711081, 10568402.0], ["2015-11-20", 60.98, 61.47, 60.02, 60.07, 12213244.0, 0.0, 1.0, 60.472178789939, 60.958098232495, 59.520173351462, 59.569756968049, 12213244.0], ["2015-11-19", 61.12, 61.36, 60.43, 60.7, 11482926.0, 0.0, 1.0, 60.611012916383, 60.849014276003, 59.926759007478, 60.19451053705, 11482926.0], ["2015-11-18", 60.04, 61.07, 59.55, 60.93, 14744924.0, 0.0, 1.0, 59.540006798097, 60.561429299796, 59.05408735554, 60.422595173351, 14744924.0], ["2015-11-17", 59.34, 60.9, 59.2, 59.92, 24563814.0, 0.0, 1.0, 58.845836165874, 60.392845003399, 58.707002039429, 59.421006118287, 24563814.0], ["2015-11-16", 56.39, 58.03, 56.36, 57.87, 13231599.0, 0.0, 1.0, 55.92040278722, 57.546745411285, 55.890652617267, 57.388077838205, 13231599.0], ["2015-11-13", 56.74, 57.06, 56.3, 56.42, 12488423.0, 0.0, 1.0, 56.267488103331, 56.58482324949, 55.831152277362, 55.950152957172, 12488423.0], ["2015-11-12", 57.64, 57.77, 56.92, 56.95, 9430173.0, 0.0, 1.0, 57.159993201903, 57.288910605031, 56.445989123046, 56.475739292998, 9430173.0], ["2015-11-11", 58.5, 58.73, 57.47, 57.58, 8663877.0, 0.0, 1.0, 58.012831407206, 58.240916043508, 56.991408905506, 57.100492861999, 8663877.0], ["2015-11-10", 58.31, 58.71, 58.31, 58.68, 7597579.0, 0.0, 1.0, 57.824413664174, 58.221082596873, 57.824413664174, 58.19133242692, 7597579.0], ["2015-11-09", 58.5, 58.78, 58.02, 58.49, 8419035.0, 0.0, 1.0, 58.012831407206, 58.290499660095, 57.536828687967, 58.002914683889, 8419035.0], ["2015-11-06", 58.92, 59.2, 58.31, 58.78, 9956857.0, 0.0, 1.0, 58.42933378654, 58.707002039429, 57.824413664174, 58.290499660095, 9956857.0], ["2015-11-05", 58.51, 58.98, 58.42, 58.61, 8827304.0, 0.0, 1.0, 58.022748130523, 58.488834126445, 57.933497620666, 58.121915363698, 8827304.0], ["2015-11-04", 58.58, 58.76, 58.19, 58.37, 10048892.0, 0.0, 1.0, 58.092165193746, 58.27066621346, 57.705412984364, 57.883914004079, 10048892.0], ["2015-11-03", 57.57, 58.33, 57.53, 58.11, 10228362.0, 0.0, 1.0, 57.090576138681, 57.844247110809, 57.050909245411, 57.626079197825, 10228362.0], ["2015-11-02", 57.29, 57.61, 56.77, 57.61, 10711972.0, 0.0, 1.0, 56.812907885792, 57.130243031951, 56.297238273283, 57.130243031951, 10711972.0], ["2015-10-30", 57.73, 58.12, 57.24, 57.24, 15759442.0, 0.0, 1.0, 57.249243711761, 57.635995921142, 56.763324269205, 56.763324269205, 15759442.0], ["2015-10-29", 57.72, 58.12, 57.48, 57.96, 12573130.0, 0.0, 1.0, 57.239326988443, 57.635995921142, 57.001325628824, 57.477328348063, 12573130.0], ["2015-10-28", 57.66, 57.72, 57.16, 57.64, 11803105.0, 0.0, 1.0, 57.179826648538, 57.239326988443, 56.683990482665, 57.159993201903, 11803105.0], ["2015-10-27", 58.01, 58.04, 57.38, 57.48, 10427703.0, 0.0, 1.0, 57.52691196465, 57.556662134602, 56.902158395649, 57.001325628824, 10427703.0], ["2015-10-26", 58.4, 58.45, 57.97, 58.02, 10820549.0, 0.0, 1.0, 57.913664174031, 57.963247790619, 57.48724507138, 57.536828687967, 10820549.0], ["2015-10-23", 59.19, 59.28, 58.22, 58.3, 13014987.0, 0.0, 1.0, 58.697085316111, 58.786335825969, 57.735163154317, 57.814496940857, 13014987.0], ["2015-10-22", 58.94, 59.96, 58.64, 58.9, 14553403.0, 0.0, 1.0, 58.449167233175, 59.460673011557, 58.151665533651, 58.409500339905, 14553403.0], ["2015-10-21", 58.8, 59.035, 58.57, 58.64, 13117593.0, 0.0, 1.0, 58.31033310673, 58.543376104691, 58.082248470428, 58.151665533651, 13117593.0], ["2015-10-20", 58.86, 59.0, 58.57, 58.75, 10264176.0, 0.0, 1.0, 58.369833446635, 58.50866757308, 58.082248470428, 58.260749490143, 10264176.0], ["2015-10-19", 58.79, 59.3, 58.5, 58.85, 17685796.0, 0.0, 1.0, 58.300416383413, 58.806169272604, 58.012831407206, 58.359916723317, 17685796.0], ["2015-10-16", 59.47, 59.49, 58.37, 58.89, 25860451.0, 0.0, 1.0, 58.974753569001, 58.994587015636, 57.883914004079, 58.399583616587, 25860451.0], ["2015-10-15", 59.7, 60.47, 58.61, 59.33, 45746392.0, 0.0, 1.0, 59.202838205303, 59.966425900748, 58.121915363698, 58.835919442556, 45746392.0], ["2015-10-14", 66.61, 67.95, 60.02, 60.03, 80604544.0, 0.0, 1.0, 66.055294017675, 67.384134942216, 59.520173351462, 59.530090074779, 80604544.0], ["2015-10-13", 66.62, 66.94, 66.26, 66.73, 8803052.0, 0.0, 1.0, 66.065210740993, 66.382545887152, 65.708208701564, 66.174294697485, 8803052.0], ["2015-10-12", 66.67, 67.0, 66.58, 66.93, 5643870.0, 0.0, 1.0, 66.11479435758, 66.442046227056, 66.025543847723, 66.372629163834, 5643870.0], ["2015-10-09", 66.94, 67.02, 66.505, 66.69, 6659137.0, 0.0, 1.0, 66.382545887152, 66.461879673691, 65.951168422842, 66.134627804215, 6659137.0], ["2015-10-08", 66.23, 66.986, 66.15, 66.88, 5939400.0, 0.0, 1.0, 65.678458531611, 66.428162814412, 65.599124745071, 66.323045547247, 5939400.0], ["2015-10-07", 65.84, 66.36, 65.77, 66.36, 7135970.0, 0.0, 1.0, 65.29170632223, 65.807375934738, 65.222289259007, 65.807375934738, 7135970.0], ["2015-10-06", 65.54, 65.95, 65.18, 65.68, 7296316.0, 0.0, 1.0, 64.994204622706, 65.400790278722, 64.637202583277, 65.13303874915, 7296316.0], ["2015-10-05", 65.21, 65.92, 65.14, 65.87, 6106475.0, 0.0, 1.0, 64.666952753229, 65.37104010877, 64.597535690007, 65.321456492182, 6106475.0], ["2015-10-02", 63.76, 64.98, 63.41, 64.98, 7049908.0, 0.0, 1.0, 63.229027872196, 64.438868116927, 62.881942556084, 64.438868116927, 7049908.0], ["2015-10-01", 64.76, 64.94, 63.875, 64.27, 7767850.0, 0.0, 1.0, 64.220700203943, 64.399201223657, 63.343070190347, 63.734780761387, 7767850.0], ["2015-09-30", 64.43, 64.94, 63.93, 64.84, 7899564.0, 0.0, 1.0, 63.893448334466, 64.399201223657, 63.397612168593, 64.300033990483, 7899564.0], ["2015-09-29", 63.75, 64.04, 63.234, 63.78, 7631139.0, 0.0, 1.0, 63.219111148878, 63.506696125085, 62.707408225697, 63.248861318831, 7631139.0], ["2015-09-28", 63.6, 63.95, 63.48, 63.66, 9260552.0, 0.0, 1.0, 63.070360299116, 63.417445615228, 62.951359619307, 63.129860639021, 9260552.0], ["2015-09-25", 64.07, 64.46, 63.62, 63.78, 7142526.0, 0.0, 1.0, 63.536446295037, 63.923198504419, 63.090193745751, 63.248861318831, 7142526.0], ["2015-09-24", 63.36, 63.975, 63.3, 63.83, 6822287.0, 0.0, 1.0, 62.832358939497, 63.442237423521, 62.772858599592, 63.298444935418, 6822287.0], ["2015-09-23", 63.72, 63.9299, 63.115, 63.72, 5856699.0, 0.0, 1.0, 63.189360978926, 63.39751300136, 62.589399218219, 63.189360978926, 5856699.0], ["2015-09-22", 63.23, 63.82, 62.915, 63.59, 8592049.0, 0.0, 1.0, 62.70344153637, 63.288528212101, 62.391064751869, 63.060443575799, 8592049.0], ["2015-09-21", 63.75, 64.0, 63.37, 63.72, 7117295.0, 0.0, 1.0, 63.219111148878, 63.467029231815, 62.842275662814, 63.189360978926, 7117295.0], ["2015-09-18", 63.75, 64.23, 63.26, 63.34, 12786032.0, 0.0, 1.0, 63.219111148878, 63.695113868117, 62.733191706322, 62.812525492862, 12786032.0], ["2015-09-17", 64.7, 65.29, 64.16, 64.47, 7039775.0, 0.0, 1.0, 64.161199864038, 64.746286539769, 63.625696804895, 63.933115227736, 7039775.0], ["2015-09-16", 64.6, 64.765, 64.05, 64.69, 5624103.0, 0.0, 1.0, 64.062032630863, 64.225658565602, 63.516612848402, 64.151283140721, 5624103.0], ["2015-09-15", 64.48, 64.7, 64.05, 64.32, 6800193.0, 0.0, 1.0, 63.943031951054, 64.161199864038, 63.516612848402, 63.784364377974, 6800193.0], ["2015-09-14", 64.65, 64.67, 63.82, 64.28, 6900095.0, 0.0, 1.0, 64.111616247451, 64.131449694086, 63.288528212101, 63.744697484704, 6900095.0], ["2015-09-11", 64.18, 64.68, 63.99, 64.65, 8060455.0, 0.0, 1.0, 63.64553025153, 64.141366417403, 63.457112508498, 64.111616247451, 8060455.0], ["2015-09-10", 64.07, 64.65, 63.83, 64.12, 14523781.0, 0.0, 1.0, 63.536446295037, 64.111616247451, 63.298444935418, 63.586029911625, 14523781.0], ["2015-09-09", 66.86, 67.01, 65.01, 65.12, 9464206.0, 0.0, 1.0, 66.303212100612, 66.451962950374, 64.46861828688, 64.577702243372, 9464206.0], ["2015-09-08", 65.23, 66.5, 65.18, 66.38, 17611247.0, 0.0, 1.0, 64.686786199864, 65.946210061183, 64.637202583277, 65.827209381373, 17611247.0], ["2015-09-04", 64.07, 64.3, 63.51, 63.89, 9180473.0, 0.0, 1.0, 63.536446295037, 63.764530931339, 62.981109789259, 63.357945275323, 9180473.0], ["2015-09-03", 64.72, 65.01, 64.39, 64.86, 8486264.0, 0.0, 1.0, 64.181033310673, 64.46861828688, 63.853781441196, 64.319867437118, 8486264.0]], "collapse"=>nil, "order"=>"desc"}}
    #GE
    # {"dataset_data"=>{"limit"=>nil, "transform"=>nil, "column_index"=>nil, "column_names"=>["Date", "Open", "High", "Low", "Close", "Volume", "Ex-Dividend", "Split Ratio", "Adj. Open", "Adj. High", "Adj. Low", "Adj. Close", "Adj. Volume"], "start_date"=>"2015-09-03", "end_date"=>"2015-12-11", "frequency"=>"daily", "data"=>[["2015-12-11", 30.32, 30.61, 30.15, 30.26, 62313471.0, 0.0, 1.0, 30.32, 30.61, 30.15, 30.26, 62313471.0], ["2015-12-10", 30.44, 30.93, 30.37, 30.65, 46332903.0, 0.0, 1.0, 30.44, 30.93, 30.37, 30.65, 46332903.0], ["2015-12-09", 30.02, 30.59, 29.96, 30.47, 50465990.0, 0.0, 1.0, 30.02, 30.59, 29.96, 30.47, 50465990.0], ["2015-12-08", 30.07, 30.38, 29.91, 30.19, 53157402.0, 0.0, 1.0, 30.07, 30.38, 29.91, 30.19, 53157402.0], ["2015-12-07", 30.42, 30.44, 30.12, 30.37, 66577572.0, 0.0, 1.0, 30.42, 30.44, 30.12, 30.37, 66577572.0], ["2015-12-04", 30.07, 30.52, 29.96, 30.49, 57121258.0, 0.0, 1.0, 30.07, 30.52, 29.96, 30.49, 57121258.0], ["2015-12-03", 30.09, 30.25, 29.965, 30.03, 62899919.0, 0.0, 1.0, 30.09, 30.25, 29.965, 30.03, 62899919.0], ["2015-12-02", 30.09, 30.23, 29.88, 29.97, 43792288.0, 0.0, 1.0, 30.09, 30.23, 29.88, 29.97, 43792288.0], ["2015-12-01", 29.99, 30.25, 29.87, 30.17, 54033438.0, 0.0, 1.0, 29.99, 30.25, 29.87, 30.17, 54033438.0], ["2015-11-30", 30.33, 30.45, 29.94, 29.94, 77112867.0, 0.0, 1.0, 30.33, 30.45, 29.94, 29.94, 77112867.0], ["2015-11-27", 30.27, 30.375, 30.19, 30.36, 33143866.0, 0.0, 1.0, 30.27, 30.375, 30.19, 30.36, 33143866.0], ["2015-11-25", 30.64, 30.65, 30.3, 30.36, 52246648.0, 0.0, 1.0, 30.64, 30.65, 30.3, 30.36, 52246648.0], ["2015-11-24", 30.33, 30.87, 30.28, 30.66, 134284520.0, 0.0, 1.0, 30.33, 30.87, 30.28, 30.66, 134284520.0], ["2015-11-23", 30.59, 30.82, 30.26, 30.59, 124520633.0, 0.0, 1.0, 30.59, 30.82, 30.26, 30.59, 124520633.0], ["2015-11-20", 30.26, 30.99, 30.21, 30.66, 210550778.0, 0.0, 1.0, 30.26, 30.99, 30.21, 30.66, 210550778.0], ["2015-11-19", 30.38, 30.51, 30.25, 30.27, 98839006.0, 0.0, 1.0, 30.38, 30.51, 30.25, 30.27, 98839006.0], ["2015-11-18", 30.22, 30.57, 30.1, 30.52, 177049385.0, 0.0, 1.0, 30.22, 30.57, 30.1, 30.52, 177049385.0], ["2015-11-17", 30.57, 30.75, 30.0, 30.32, 427142490.0, 0.0, 1.0, 30.57, 30.75, 30.0, 30.32, 427142490.0], ["2015-11-16", 29.88, 30.6, 29.77, 30.36, 281519950.0, 0.0, 1.0, 29.88, 30.6, 29.77, 30.36, 281519950.0], ["2015-11-13", 29.86, 30.49, 29.81, 30.28, 246111560.0, 0.0, 1.0, 29.86, 30.49, 29.81, 30.28, 246111560.0], ["2015-11-12", 30.41, 30.9, 30.11, 30.16, 291401426.0, 0.0, 1.0, 30.41, 30.9, 30.11, 30.16, 291401426.0], ["2015-11-11", 30.2, 30.82, 30.2, 30.67, 197193778.0, 0.0, 1.0, 30.2, 30.82, 30.2, 30.67, 197193778.0], ["2015-11-10", 29.63, 30.27, 29.61, 30.12, 212083988.0, 0.0, 1.0, 29.63, 30.27, 29.61, 30.12, 212083988.0], ["2015-11-09", 29.76, 29.95, 29.38, 29.75, 144317799.0, 0.0, 1.0, 29.76, 29.95, 29.38, 29.75, 144317799.0], ["2015-11-06", 29.44, 29.95, 29.25, 29.92, 125860153.0, 0.0, 1.0, 29.44, 29.95, 29.25, 29.92, 125860153.0], ["2015-11-05", 29.47, 29.74, 29.31, 29.64, 122548942.0, 0.0, 1.0, 29.47, 29.74, 29.31, 29.64, 122548942.0], ["2015-11-04", 29.55, 29.785, 29.46, 29.54, 105074323.0, 0.0, 1.0, 29.55, 29.785, 29.46, 29.54, 105074323.0], ["2015-11-03", 29.21, 29.79, 29.18, 29.59, 95810223.0, 0.0, 1.0, 29.21, 29.79, 29.18, 29.59, 95810223.0], ["2015-11-02", 28.94, 29.4, 28.88, 29.4, 59470286.0, 0.0, 1.0, 28.94, 29.4, 28.88, 29.4, 59470286.0], ["2015-10-30", 29.22, 29.325, 28.91, 28.92, 70467313.0, 0.0, 1.0, 29.22, 29.325, 28.91, 28.92, 70467313.0], ["2015-10-29", 29.17, 29.38, 29.06, 29.34, 42298192.0, 0.0, 1.0, 29.17, 29.38, 29.06, 29.34, 42298192.0], ["2015-10-28", 29.33, 29.58, 29.15, 29.39, 71032793.0, 0.0, 1.0, 29.33, 29.58, 29.15, 29.39, 71032793.0], ["2015-10-27", 29.41, 29.64, 29.23, 29.46, 66900929.0, 0.0, 1.0, 29.41, 29.64, 29.23, 29.46, 66900929.0], ["2015-10-26", 29.52, 29.66, 29.41, 29.55, 47726202.0, 0.0, 1.0, 29.52, 29.66, 29.41, 29.55, 47726202.0], ["2015-10-23", 29.7, 29.83, 29.42, 29.51, 76709189.0, 0.0, 1.0, 29.7, 29.83, 29.42, 29.51, 76709189.0], ["2015-10-22", 28.95, 29.74, 28.91, 29.58, 81399929.0, 0.0, 1.0, 28.95, 29.74, 28.91, 29.58, 81399929.0], ["2015-10-21", 28.79, 29.24, 28.78, 28.85, 65404095.0, 0.0, 1.0, 28.79, 29.24, 28.78, 28.85, 65404095.0], ["2015-10-20", 28.82, 29.0, 28.7, 28.78, 73599918.0, 0.0, 1.0, 28.82, 29.0, 28.7, 28.78, 73599918.0], ["2015-10-19", 28.8, 29.56, 28.75, 28.99, 119909338.0, 0.0, 1.0, 28.8, 29.56, 28.75, 28.99, 119909338.0], ["2015-10-16", 28.61, 29.19, 28.215, 28.98, 141526344.0, 0.0, 1.0, 28.61, 29.19, 28.215, 28.98, 141526344.0], ["2015-10-15", 27.8, 28.17, 27.64, 28.03, 76773988.0, 0.0, 1.0, 27.8, 28.17, 27.64, 28.03, 76773988.0], ["2015-10-14", 27.74, 27.84, 27.48, 27.6, 38900523.0, 0.0, 1.0, 27.74, 27.84, 27.48, 27.6, 38900523.0], ["2015-10-13", 27.97, 28.28, 27.87, 27.87, 41939722.0, 0.0, 1.0, 27.97, 28.28, 27.87, 27.87, 41939722.0], ["2015-10-12", 27.98, 28.17, 27.91, 28.09, 25239634.0, 0.0, 1.0, 27.98, 28.17, 27.91, 28.09, 25239634.0], ["2015-10-09", 27.98, 28.17, 27.894, 28.07, 45590521.0, 0.0, 1.0, 27.98, 28.17, 27.894, 28.07, 45590521.0], ["2015-10-08", 27.63, 28.2, 27.43, 28.03, 50995630.0, 0.0, 1.0, 27.63, 28.2, 27.43, 28.03, 50995630.0], ["2015-10-07", 27.5, 27.77, 27.32, 27.77, 65670964.0, 0.0, 1.0, 27.5, 27.77, 27.32, 27.77, 65670964.0], ["2015-10-06", 26.99, 27.41, 26.96, 27.29, 70409004.0, 0.0, 1.0, 26.99, 27.41, 26.96, 27.29, 70409004.0], ["2015-10-05", 26.37, 27.2, 26.22, 26.82, 103735410.0, 0.0, 1.0, 26.37, 27.2, 26.22, 26.82, 103735410.0], ["2015-10-02", 24.87, 25.49, 24.83, 25.47, 42508524.0, 0.0, 1.0, 24.87, 25.49, 24.83, 25.47, 42508524.0], ["2015-10-01", 25.15, 25.31, 24.79, 25.19, 39649658.0, 0.0, 1.0, 25.15, 25.31, 24.79, 25.19, 39649658.0], ["2015-09-30", 24.73, 25.24, 24.69, 25.22, 43496670.0, 0.0, 1.0, 24.73, 25.24, 24.69, 25.22, 43496670.0], ["2015-09-29", 24.33, 24.6, 24.26, 24.57, 41155770.0, 0.0, 1.0, 24.33, 24.6, 24.26, 24.57, 41155770.0], ["2015-09-28", 24.69, 24.74, 24.31, 24.31, 42431322.0, 0.0, 1.0, 24.69, 24.74, 24.31, 24.31, 42431322.0], ["2015-09-25", 25.0, 25.04, 24.86, 24.92, 38817999.0, 0.0, 1.0, 25.0, 25.04, 24.86, 24.92, 38817999.0], ["2015-09-24", 24.87, 25.45, 24.65, 24.91, 52486143.0, 0.0, 1.0, 24.87, 25.45, 24.65, 24.91, 52486143.0], ["2015-09-23", 25.01, 25.33, 24.98, 25.14, 41087975.0, 0.0, 1.0, 25.01, 25.33, 24.98, 25.14, 41087975.0], ["2015-09-22", 24.76, 25.16, 24.6, 25.11, 43613135.0, 0.0, 1.0, 24.76, 25.16, 24.6, 25.11, 43613135.0], ["2015-09-21", 24.89, 25.2, 24.8399, 25.09, 29559376.0, 0.0, 1.0, 24.89, 25.2, 24.8399, 25.09, 29559376.0], ["2015-09-18", 25.15, 25.205, 24.71, 24.8, 76131207.0, 0.0, 1.0, 25.15, 25.205, 24.71, 24.8, 76131207.0], ["2015-09-17", 25.5, 25.93, 25.27, 25.35, 47782983.0, 0.23, 1.0, 25.5, 25.93, 25.27, 25.35, 47782983.0], ["2015-09-16", 25.53, 26.03, 25.42, 25.93, 61367160.0, 0.0, 1.0, 25.300449569977, 25.795953870211, 25.191438623925, 25.696853010164, 61367160.0], ["2015-09-15", 24.9, 25.45, 24.7, 25.3, 45848968.0, 0.0, 1.0, 24.676114151681, 25.221168881939, 24.477912431587, 25.072517591869, 45848968.0], ["2015-09-14", 24.97, 24.98, 24.6, 24.77, 26219818.0, 0.0, 1.0, 24.745484753714, 24.755394839719, 24.37881157154, 24.54728303362, 26219818.0], ["2015-09-11", 24.74, 24.96, 24.5, 24.95, 31900975.0, 0.0, 1.0, 24.517552775606, 24.735574667709, 24.279710711493, 24.725664581704, 31900975.0], ["2015-09-10", 24.56, 24.86, 24.5, 24.68, 35036609.0, 0.0, 1.0, 24.339171227521, 24.636473807662, 24.279710711493, 24.458092259578, 35036609.0], ["2015-09-09", 25.2, 25.22, 24.48, 24.55, 34611248.0, 0.0, 1.0, 24.973416731822, 24.993236903831, 24.259890539484, 24.329261141517, 34611248.0], ["2015-09-08", 24.51, 24.98, 24.27, 24.96, 45840337.0, 0.0, 1.0, 24.289620797498, 24.755394839719, 24.051778733385, 24.735574667709, 45840337.0], ["2015-09-04", 24.18, 24.18, 23.85, 24.0, 35464785.0, 0.0, 1.0, 23.962587959343, 23.962587959343, 23.635555121188, 23.784206411259, 35464785.0], ["2015-09-03", 24.76, 24.95, 24.39, 24.51, 33296768.0, 0.0, 1.0, 24.537372947615, 24.725664581704, 24.170699765442, 24.289620797498, 33296768.0]], "collapse"=>nil, "order"=>"desc"}}
  end

  def get_close
    @close = @data["dataset_data"]["data"][0][4]
  end
end

class Daily_fetch
  attr_accessor :collection, :radar_watch, :buy

  def initialize
    @collection = []
    @radar_watch = []
    @buy_list = []
    fetch_engine_go
  end

  def fetch_engine_go
    queries = ['aapl','amzn','wmt','msft','omx','xom','gm','ge','cvx','brka','vz']#,'EN','EH','AJ','CS','CX','CM','CN','CO','CY','DO','FE','FQ','FR','FU','US','ZB','TY','ZN','FV','ZF','TU','ZT','NZ','QS','NI','SR','J8','NJ','SA','FF','ZQ','DJ','ZD','DD','AH','DH','ES','EW','SO','PC','EO','EA','NQ','NC','NB','FN','ER','J7','E7','EB','E8','MB','MF','MG','MH','MM','MN','AD','A6','BP','B6','CD','D6','JY','J6','EC','E6','SF','S6','MQ','M6','BR','L6','NE','N6','RU','R6','RA','T6','RP','RY','RF','SK','NR','UA','UB','UC','UE','UF','UG','UI','UK','UN','UR','UP','WC','WE','WH','WP','WU','WY','WZ','KZ','QR','QV','QT','E4','E5','MB','MF','MG','MH','MM','MN','CZ','ED','GE','EY','GJ','EL','EM','GH','C7','JB','FD','SP','ND','MD','SG','SU','PH','PP','PZ','PR','LS','XY','XZ','YQ','PI','PF','PT','NK','NL','NY','GI','GD','G7','G8','LD','F3','PB','PD','FC','GF','LC','LE','LH','HE','DB','BD','DA','DL','DF','DN','DK','LB','LS','DG','XP','LP','KW','KE','MV','MW','IH','IC','IS','IP','IW','RS','AL','HG','GC','SI','AM','CL','WS','SC','RE','CP','QB','MT','FH','FL','HO','BH','RB','RT','LR','LT','LL','PN','NG','HP','HH','QL','PA','PL','AN','AO','F0','R3','JM','JP','HT','UX','HV','R2','Q5','PG','PJ','C6','CJ','KT','KG','KA','RD','RH','RO','Q6','T4','T9','V6','V7','V8','Y3','O3','RQ','QM','QH','QU','QG','YN','YS','QC','QO','QI','OQ','KC','CC','SB','SD','CT','OJ','CR','CI','YV','RI','RJ','DX','EX','OL','AR','YA','EU','YP','YY','YD','YF','OR','SY','SS','AU','ZX','EP','AS','HY','KU','NS','EQ','GB','EJ','RK','RZ','EK','ZY','UZ','GZ','UY','GY','PY','PV','GN','PW','PK','PX','PS','ZJ','KY','KJ','CB','WI','ZU','ZV','LF','NF','LG','LO','LM','LU','LV','LQ','CK','CQ','VI','VM','VJ','VE','VL','VO','YG','YI','ZG','ZI','DE','DI','DQ',]
    queries.each do |symbol|
      symbol.upcase!
      commodity = Commodity.new symbol
      @collection << commodity
    end
    filter
  end

  def filter
    @collection.each do |commodity|
      # if commodity.close > commodity.sma50 && commodity.sma_cleared
      #   puts "#{commodity.name} BUY BUY BUY $$$$"
      #   @buy_list << commodity.name
      # end
      # if commodity.sma_cleared && commodity.sma50/commodity.close > 0.97
      #   puts "#{commodity.name} is a potential Cow"
      #   @radar_watch << commodity.name
      # end
      @buy_list << commodity.name
    end
    return [@radar_watch, @buy_list]
  end
end

def fetch
  @response = Daily_fetch.new
  logger.info @response

  render json: @response
end
